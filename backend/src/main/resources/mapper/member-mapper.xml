<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.community.backend.member.dao.MemberDao">


  <!-- 이메일 중복 체크 -->
  <select id="countByEmail" parameterType="string" resultType="int">
    SELECT COUNT(*)
    FROM MEMBER
    WHERE EMAIL = #{email}
  </select>
  
    <select id="countByNickname" resultType="int">
    SELECT COUNT(*)
    FROM MEMBER
    WHERE NICKNAME = #{nickname}
  </select>

  <!--
    base = '홍길동'
    조회 대상: '홍길동#0001', '홍길동#0002' ...
    그 중 최대 숫자(예: 12)를 반환
  -->
  <select id="selectMaxNicknameSuffix" resultType="int">
    SELECT NVL(MAX(TO_NUMBER(SUBSTR(NICKNAME, LENGTH(#{base}) + 2))), 0)
    FROM MEMBER
    WHERE NICKNAME LIKE #{base} || '#____'
  </select>

  <!-- 회원가입 -->
  <insert id="insertMember" parameterType="member">
  INSERT INTO MEMBER (
    MEMBER_ID, EMAIL, PASSWORD_HASH, NAME, NICKNAME, ROLE, STATUS, CREATED_AT
  ) VALUES (
    MEMBER_SEQ.NEXTVAL,
    #{email},
    #{passwordHash},
    #{name},
    #{nickname},
    #{role},
    #{status},
    SYSDATE
  )
  </insert>
  
  <!-- 로그인 로직 -->
  <select id="selectMemberByEmail" parameterType="string" resultType="member">
    SELECT 
      MEMBER_ID AS memberId,
      EMAIL AS email,
      PASSWORD_HASH AS passwordHash,
      NAME AS name,
      NICKNAME AS nickname,
      ROLE AS role,
      STATUS AS status
    FROM MEMBER
    WHERE EMAIL = #{email}
      AND STATUS = 'ACTIVE'
  </select>
  
  <!-- ========== 마이페이지 관련 쿼리 ========== -->

  <!-- 회원 정보 조회 (ID로) -->
  <select id="selectMemberById" resultType="member">
    SELECT 
      MEMBER_ID as memberId,
      EMAIL as email,
      NAME as name,
      NICKNAME as nickname,
      ROLE as role,
      STATUS as status,
      TO_CHAR(CREATED_AT, 'YYYY-MM-DD') as createdAt,
      TO_CHAR(UPDATED_AT, 'YYYY-MM-DD') as updatedAt,
      TO_CHAR(LAST_LOGIN_AT, 'YYYY-MM-DD HH24:MI:SS') as lastLoginAt
    FROM MEMBER
    WHERE MEMBER_ID = #{memberId}
  </select>

  <!-- 작성한 글 개수 조회 -->
  <select id="countMemberPosts" resultType="int">
    SELECT COUNT(*)
    FROM POST
    WHERE AUTHOR_ID = #{memberId}
      AND IS_DELETED = 'N'
  </select>

  <!-- 작성한 댓글 개수 조회 -->
  <select id="countMemberComments" resultType="int">
    SELECT COUNT(*)
    FROM COMMENTS
    WHERE AUTHOR_ID = #{memberId}
      AND IS_DELETED = 'N'
  </select>

  <!-- 받은 좋아요 개수 조회 (게시글에 받은 좋아요 합계) -->
  <select id="countReceivedLikes" resultType="int">
    SELECT NVL(SUM(p.LIKE_COUNT), 0)
    FROM POST p
    WHERE p.AUTHOR_ID = #{memberId}
      AND p.IS_DELETED = 'N'
  </select>

  <!-- 작성한 글 목록 조회 -->
  <select id="selectMemberPosts" resultType="map">
    SELECT 
      p.POST_ID as postId,
      p.TITLE as title,
      p.CONTENT as content,
      bc.CATEGORY_NAME as category,
      TO_CHAR(p.CREATED_AT, 'YYYY. MM. DD.') as createdAt,
      NVL(p.VIEW_COUNT, 0) as viewCount,
      NVL(p.COMMENT_COUNT, 0) as commentCount,
      NVL(p.LIKE_COUNT, 0) as likeCount
    FROM POST p
    LEFT JOIN BOARD_CATEGORY bc ON p.CATEGORY_ID = bc.CATEGORY_ID
    WHERE p.AUTHOR_ID = #{memberId}
      AND p.IS_DELETED = 'N'
    ORDER BY p.CREATED_AT DESC
  </select>

  <!-- 작성한 댓글 목록 조회 -->
  <select id="selectMemberComments" resultType="map">
    SELECT 
      c.COMMENT_ID as commentId,
      c.CONTENT as content,
      TO_CHAR(c.CREATED_AT, 'YYYY. MM. DD.') as createdAt,
      c.POST_ID as postId,
      p.TITLE as postTitle,
      bc.CATEGORY_NAME as category
    FROM COMMENTS c
    JOIN POST p ON c.POST_ID = p.POST_ID
    LEFT JOIN BOARD_CATEGORY bc ON p.CATEGORY_ID = bc.CATEGORY_ID
    WHERE c.AUTHOR_ID = #{memberId}
      AND c.IS_DELETED = 'N'
      AND p.IS_DELETED = 'N'
    ORDER BY c.CREATED_AT DESC
  </select>

  <!-- 좋아요한 글 목록 조회 -->
  <select id="selectMemberLikedPosts" resultType="map">
    SELECT 
      p.POST_ID as postId,
      p.TITLE as title,
      p.CONTENT as content,
      bc.CATEGORY_NAME as category,
      TO_CHAR(p.CREATED_AT, 'YYYY. MM. DD.') as createdAt,
      NVL(p.VIEW_COUNT, 0) as viewCount,
      NVL(p.COMMENT_COUNT, 0) as commentCount,
      NVL(p.LIKE_COUNT, 0) as likeCount,
      NVL(m.NICKNAME, m.NAME) as authorNickname
    FROM POST_LIKE pl
    JOIN POST p ON pl.POST_ID = p.POST_ID
    JOIN MEMBER m ON p.AUTHOR_ID = m.MEMBER_ID
    LEFT JOIN BOARD_CATEGORY bc ON p.CATEGORY_ID = bc.CATEGORY_ID
    WHERE pl.MEMBER_ID = #{memberId}
      AND p.IS_DELETED = 'N'
    ORDER BY pl.CREATED_AT DESC
  </select>
  
  
  <!-- 이메일로 회원 조회 -->
  <select id="selectByEmail" parameterType="string" resultType="member">
    SELECT
      MEMBER_ID     AS memberId,
      EMAIL         AS email,
      PASSWORD_HASH AS passwordHash,
      NAME          AS name,
      NICKNAME      AS nickname,
      ROLE          AS role,
      STATUS        AS status,
      CREATED_AT    AS createdAt,
      UPDATED_AT    AS updatedAt,
      LAST_LOGIN_AT AS lastLoginAt
    FROM MEMBER
    WHERE EMAIL = #{email}
  </select>

  <!-- ID로 회원 조회 -->
  <select id="selectById" parameterType="long" resultType="member">
    SELECT
      MEMBER_ID     AS memberId,
      EMAIL         AS email,
      PASSWORD_HASH AS passwordHash,
      NAME          AS name,
      NICKNAME      AS nickname,
      ROLE          AS role,
      STATUS        AS status,
      CREATED_AT    AS createdAt,
      UPDATED_AT    AS updatedAt,
      LAST_LOGIN_AT AS lastLoginAt
    FROM MEMBER
    WHERE MEMBER_ID = #{memberId}
  </select>

  <!-- 마지막 로그인 시간 업데이트 -->
  <update id="updateLastLoginAt" parameterType="long">
    UPDATE MEMBER
    SET LAST_LOGIN_AT = SYSDATE
    WHERE MEMBER_ID = #{memberId}
  </update>
  
  <!-- ========== 아이디/비밀번호 찾기 관련 쿼리 ========== -->

<!-- 이름과 이메일로 회원 조회 (아이디 찾기) -->
<select id="selectMemberByNameAndEmail" resultType="member">
  SELECT 
    MEMBER_ID AS memberId,
    EMAIL AS email,
    NAME AS name,
    NICKNAME AS nickname,
    ROLE AS role,
    STATUS AS status,
    TO_CHAR(CREATED_AT, 'YYYY-MM-DD') AS createdAt
  FROM MEMBER
  WHERE NAME = #{name}
    AND EMAIL = #{email}
    AND STATUS = 'ACTIVE'
</select>

<!-- 이메일과 이름으로 회원 조회 (계정 확인) -->
<select id="selectMemberByEmailAndName" resultType="member">
  SELECT 
    MEMBER_ID AS memberId,
    EMAIL AS email,
    NAME AS name,
    NICKNAME AS nickname,
    ROLE AS role,
    STATUS AS status,
    TO_CHAR(CREATED_AT, 'YYYY-MM-DD') AS createdAt
  FROM MEMBER
  WHERE EMAIL = #{email}
    AND NAME = #{name}
    AND STATUS = 'ACTIVE'
</select>

<!-- 비밀번호 업데이트 -->
<update id="updatePassword">
  UPDATE MEMBER
  SET PASSWORD_HASH = #{passwordHash},
      UPDATED_AT = SYSDATE
  WHERE MEMBER_ID = #{memberId}
</update>

</mapper>