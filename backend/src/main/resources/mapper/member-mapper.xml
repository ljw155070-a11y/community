<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.community.backend.member.dao.MemberDao">

  <select id="countByEmail" parameterType="string" resultType="int">
    SELECT COUNT(*)
    FROM MEMBER
    WHERE EMAIL = #{email}
  </select>

  <select id="countByNickname" resultType="int">
    SELECT COUNT(*)
    FROM MEMBER
    WHERE NICKNAME = #{nickname}
  </select>

  <select id="selectMaxNicknameSuffix" resultType="int">
    SELECT NVL(MAX(TO_NUMBER(SUBSTR(NICKNAME, LENGTH(#{base}) + 2))), 0)
    FROM MEMBER
    WHERE NICKNAME LIKE #{base} || '#____'
  </select>

  <insert id="insertMember" parameterType="member">
    INSERT INTO MEMBER (
      MEMBER_ID, EMAIL, PASSWORD_HASH, NAME, NICKNAME, ROLE, STATUS, CREATED_AT
    ) VALUES (
      MEMBER_SEQ.NEXTVAL,
      #{email},
      #{passwordHash},
      #{name},
      #{nickname},
      #{role},
      #{status},
      SYSDATE
    )
  </insert>

  <select id="selectMemberByEmail" parameterType="string" resultType="member">
    SELECT
      MEMBER_ID AS memberId,
      EMAIL AS email,
      PASSWORD_HASH AS passwordHash,
      NAME AS name,
      NICKNAME AS nickname,
      ROLE AS role,
      STATUS AS status,
      PROFILE_IMAGE AS profileImage
    FROM MEMBER
    WHERE EMAIL = #{email}
      AND STATUS = 'ACTIVE'
  </select>

  <select id="selectMemberById" resultType="member">
    SELECT
      MEMBER_ID as memberId,
      EMAIL as email,
      NAME as name,
      NICKNAME as nickname,
      ROLE as role,
      STATUS as status,
      TO_CHAR(CREATED_AT, 'YYYY-MM-DD') as createdAt,
      TO_CHAR(UPDATED_AT, 'YYYY-MM-DD') as updatedAt,
      TO_CHAR(LAST_LOGIN_AT, 'YYYY-MM-DD HH24:MI:SS') as lastLoginAt,
      PROFILE_IMAGE as profileImage
    FROM MEMBER
    WHERE MEMBER_ID = #{memberId}
  </select>

  <select id="countMemberPosts" resultType="int">
    SELECT COUNT(*)
    FROM POST
    WHERE AUTHOR_ID = #{memberId}
      AND IS_DELETED = 'N'
  </select>

  <select id="countMemberComments" resultType="int">
    SELECT COUNT(*)
    FROM COMMENTS
    WHERE AUTHOR_ID = #{memberId}
      AND IS_DELETED = 'N'
  </select>

  <select id="countReceivedLikes" resultType="int">
    SELECT NVL(SUM(p.LIKE_COUNT), 0)
    FROM POST p
    WHERE p.AUTHOR_ID = #{memberId}
      AND p.IS_DELETED = 'N'
  </select>

  <!-- ✅ 작성한 글 목록: CLOB -> 문자열 변환 (500 해결) -->
  <select id="selectMemberPosts" resultType="map">
    SELECT
      p.POST_ID as postId,
      p.TITLE as title,
      DBMS_LOB.SUBSTR(p.CONTENT, 1000, 1) as content,
      bc.CATEGORY_NAME as category,
      TO_CHAR(p.CREATED_AT, 'YYYY. MM. DD.') as createdAt,
      NVL(p.VIEW_COUNT, 0) as viewCount,
      NVL(p.COMMENT_COUNT, 0) as commentCount,
      NVL(p.LIKE_COUNT, 0) as likeCount
    FROM POST p
    LEFT JOIN BOARD_CATEGORY bc ON p.CATEGORY_ID = bc.CATEGORY_ID
    WHERE p.AUTHOR_ID = #{memberId}
      AND p.IS_DELETED = 'N'
    ORDER BY p.CREATED_AT DESC
  </select>

  <select id="selectMemberComments" resultType="map">
    SELECT
      c.COMMENT_ID as commentId,
      c.CONTENT as content,
      TO_CHAR(c.CREATED_AT, 'YYYY. MM. DD.') as createdAt,
      c.POST_ID as postId,
      p.TITLE as postTitle,
      bc.CATEGORY_NAME as category
    FROM COMMENTS c
    JOIN POST p ON c.POST_ID = p.POST_ID
    LEFT JOIN BOARD_CATEGORY bc ON p.CATEGORY_ID = bc.CATEGORY_ID
    WHERE c.AUTHOR_ID = #{memberId}
      AND c.IS_DELETED = 'N'
      AND p.IS_DELETED = 'N'
    ORDER BY c.CREATED_AT DESC
  </select>

  <!-- ✅ 좋아요한 글 목록도 CLOB 안전 처리 -->
  <select id="selectMemberLikedPosts" resultType="map">
    SELECT
      p.POST_ID as postId,
      p.TITLE as title,
      DBMS_LOB.SUBSTR(p.CONTENT, 1000, 1) as content,
      bc.CATEGORY_NAME as category,
      TO_CHAR(p.CREATED_AT, 'YYYY. MM. DD.') as createdAt,
      NVL(p.VIEW_COUNT, 0) as viewCount,
      NVL(p.COMMENT_COUNT, 0) as commentCount,
      NVL(p.LIKE_COUNT, 0) as likeCount,
      NVL(m.NICKNAME, m.NAME) as authorNickname
    FROM POST_LIKE pl
    JOIN POST p ON pl.POST_ID = p.POST_ID
    JOIN MEMBER m ON p.AUTHOR_ID = m.MEMBER_ID
    LEFT JOIN BOARD_CATEGORY bc ON p.CATEGORY_ID = bc.CATEGORY_ID
    WHERE pl.MEMBER_ID = #{memberId}
      AND p.IS_DELETED = 'N'
    ORDER BY pl.CREATED_AT DESC
  </select>

  <update id="updateLastLoginAt" parameterType="long">
    UPDATE MEMBER
    SET LAST_LOGIN_AT = SYSDATE
    WHERE MEMBER_ID = #{memberId}
  </update>

  <!-- ✅ 프로필 이미지 저장명 업데이트 -->
  <update id="updateProfileImage">
    UPDATE MEMBER
    SET PROFILE_IMAGE = #{saveName},
        UPDATED_AT = SYSDATE
    WHERE MEMBER_ID = #{memberId}
  </update>

  <select id="selectMemberByNameAndEmail" resultType="member">
    SELECT
      MEMBER_ID AS memberId,
      EMAIL AS email,
      NAME AS name,
      NICKNAME AS nickname,
      ROLE AS role,
      STATUS AS status,
      PROFILE_IMAGE AS profileImage,
      TO_CHAR(CREATED_AT, 'YYYY-MM-DD') AS createdAt
    FROM MEMBER
    WHERE NAME = #{name}
      AND EMAIL = #{email}
      AND STATUS = 'ACTIVE'
  </select>

  <select id="selectMemberByEmailAndName" resultType="member">
    SELECT
      MEMBER_ID AS memberId,
      EMAIL AS email,
      NAME AS name,
      NICKNAME AS nickname,
      ROLE AS role,
      STATUS AS status,
      PROFILE_IMAGE AS profileImage,
      TO_CHAR(CREATED_AT, 'YYYY-MM-DD') AS createdAt
    FROM MEMBER
    WHERE EMAIL = #{email}
      AND NAME = #{name}
      AND STATUS = 'ACTIVE'
  </select>

  <update id="updatePassword">
    UPDATE MEMBER
    SET PASSWORD_HASH = #{passwordHash},
        UPDATED_AT = SYSDATE
    WHERE MEMBER_ID = #{memberId}
  </update>

</mapper>
