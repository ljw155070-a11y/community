<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.community.backend.post.dao.PostSsrDao">

	<!-- 카테고리 탭 -->
	<select id="selectActiveCategories"
		resultType="kr.co.community.backend.category.dto.BoardCategoryDTO">
		SELECT
		CATEGORY_ID AS categoryId,
		CATEGORY_NAME AS categoryName,
		SORT_ORDER AS sortOrder,
		IS_ACTIVE AS isActive
		FROM BOARD_CATEGORY
		WHERE IS_ACTIVE = 'Y'
		ORDER BY SORT_ORDER ASC, CATEGORY_ID ASC
	</select>

	<!-- total -->
	<select id="countPostList" resultType="int">
		SELECT COUNT(*)
		FROM POST P
		JOIN BOARD_CATEGORY C ON C.CATEGORY_ID = P.CATEGORY_ID
		JOIN MEMBER M ON M.MEMBER_ID = P.AUTHOR_ID
		WHERE P.IS_DELETED = 'N'
		AND C.IS_ACTIVE = 'Y'
		<if test="categoryId != null">
			AND P.CATEGORY_ID = #{categoryId}
		</if>
		<if test="q != null and q != ''">
			AND (
			P.TITLE LIKE '%' || #{q} || '%'
			OR DBMS_LOB.SUBSTR(P.CONTENT, 2000, 1) LIKE '%' || #{q} || '%'
			OR NVL(M.NICKNAME, M.NAME) LIKE '%' || #{q} || '%'
			)
		</if>
	</select>

	<!-- list -->
	<select id="selectPostList"
		resultType="kr.co.community.backend.post.dto.PostListDTO">
		SELECT *
		FROM (
		SELECT
		T.*,
		ROW_NUMBER() OVER (
		<choose>
			<when test="sort == 'VIEWS'">
				ORDER BY T.viewCount DESC, T.createdAt DESC, T.postId DESC
			</when>
			<when test="sort == 'LIKES'">
				ORDER BY T.likeCount DESC, T.createdAt DESC, T.postId DESC
			</when>
			<otherwise>
				ORDER BY T.createdAt DESC, T.postId DESC
			</otherwise>
		</choose>
		) AS RN
		FROM (
		SELECT
		P.POST_ID AS postId,
		P.CATEGORY_ID AS categoryId,
		C.CATEGORY_NAME AS categoryName,
		P.AUTHOR_ID AS authorId,
		NVL(M.NICKNAME, M.NAME) AS authorName,
		P.TITLE AS title,
		DBMS_LOB.SUBSTR(P.CONTENT, 120, 1) AS contentPreview,

		/* ✅ 목록용 첫 이미지 (Oracle 11g 호환) */
		(
  SELECT MAX(PI.SAVE_NAME)
         KEEP (DENSE_RANK FIRST ORDER BY PI.SORT_NO ASC, PI.IMG_ID ASC)
  FROM POST_IMAGE PI
  WHERE PI.POST_ID = P.POST_ID
) AS firstImageSaveName,

		P.VIEW_COUNT AS viewCount,
		P.LIKE_COUNT AS likeCount,
		P.COMMENT_COUNT AS commentCount,
		P.CREATED_AT AS createdAt
		FROM POST P
		JOIN BOARD_CATEGORY C ON C.CATEGORY_ID = P.CATEGORY_ID
		JOIN MEMBER M ON M.MEMBER_ID = P.AUTHOR_ID
		WHERE P.IS_DELETED = 'N'
		AND C.IS_ACTIVE = 'Y'
		<if test="categoryId != null">
			AND P.CATEGORY_ID = #{categoryId}
		</if>
		<if test="q != null and q != ''">
			AND (
			P.TITLE LIKE '%' || #{q} || '%'
			OR DBMS_LOB.SUBSTR(P.CONTENT, 2000, 1) LIKE '%' || #{q} || '%'
			OR NVL(M.NICKNAME, M.NAME) LIKE '%' || #{q} || '%'
			)
		</if>
		) T
		)
		WHERE RN BETWEEN #{startRow} AND #{endRow}
		ORDER BY RN
	</select>



	<!-- 게시글 단건 조회 -->
	<select id="selectPostById" parameterType="long"
		resultType="kr.co.community.backend.post.dto.PostDTO">
  SELECT
    P.POST_ID AS postId,
    P.CATEGORY_ID AS categoryId,
    P.AUTHOR_ID AS authorId,
    P.TITLE AS title,
    P.CONTENT AS content,

    P.BLOCKS_META AS blocksMeta, 

    P.VIEW_COUNT AS viewCount,
    P.LIKE_COUNT AS likeCount,
    P.COMMENT_COUNT AS commentCount,
    P.IS_DELETED AS isDeleted,
    P.CREATED_AT AS createdAt,
    P.UPDATED_AT AS updatedAt,
    C.CATEGORY_NAME AS category,
    NVL(M.NICKNAME, M.NAME) AS authorName,
    M.BIO AS authorBio
  FROM POST P
  LEFT JOIN BOARD_CATEGORY C ON P.CATEGORY_ID = C.CATEGORY_ID
  LEFT JOIN MEMBER M ON P.AUTHOR_ID = M.MEMBER_ID
  WHERE P.POST_ID = #{postId}
    AND P.IS_DELETED = 'N'
	</select>
	
	<!-- ✅ 게시글의 이미지 조회 (정렬 순서대로) -->
	<select id="selectImagesByPostId" parameterType="long"
		resultType="kr.co.community.backend.post.dto.PostImageDTO">
		SELECT
		IMG_ID AS imgId,
		POST_ID AS postId,
		ORIG_NAME AS origName,
		SAVE_NAME AS saveName,
		CONTENT_TYPE AS contentType,
		FILE_SIZE AS fileSize,
		SORT_NO AS sortNo,
		CREATED_AT AS createdAt
		FROM POST_IMAGE
		WHERE POST_ID = #{postId}
		ORDER BY SORT_NO ASC, IMG_ID ASC
	</select>
	
	<!-- 조회수 증가 -->
	<update id="updateViewCount" parameterType="long">
		UPDATE POST
		SET VIEW_COUNT = VIEW_COUNT + 1
		WHERE POST_ID = #{postId}
	</update>

	<!-- 댓글 목록 조회 -->
	<select id="selectCommentsByPostId" parameterType="long"
		resultType="kr.co.community.backend.post.dto.CommentDTO">
		SELECT
		C.COMMENT_ID AS commentId,
		C.POST_ID AS postId,
		C.AUTHOR_ID AS authorId,
		C.PARENT_COMMENT_ID AS parentCommentId,
		C.CONTENT AS content,
		C.IS_DELETED AS isDeleted,
		C.CREATED_AT AS createdAt,
		C.UPDATED_AT AS updatedAt,
		NVL(M.NICKNAME, M.NAME) AS authorName
		FROM COMMENTS C
		LEFT JOIN MEMBER M ON C.AUTHOR_ID = M.MEMBER_ID
		WHERE C.POST_ID = #{postId}
		AND C.IS_DELETED = 'N'
		AND C.PARENT_COMMENT_ID IS NULL
		ORDER BY C.CREATED_AT ASC
	</select>

	<!-- 좋아요 여부 확인 -->
	<select id="selectPostLikeExists" resultType="int">
		SELECT COUNT(*)
		FROM POST_LIKE
		WHERE POST_ID = #{postId}
		AND MEMBER_ID = #{memberId}
	</select>

	<!-- 좋아요 추가 -->
	<insert id="insertPostLike">
		INSERT INTO POST_LIKE (POST_ID, MEMBER_ID, CREATED_AT)
		VALUES (#{postId}, #{memberId}, SYSDATE)
	</insert>

	<!-- 좋아요 취소 -->
	<delete id="deletePostLike">
		DELETE FROM POST_LIKE
		WHERE POST_ID = #{postId}
		AND MEMBER_ID = #{memberId}
	</delete>

	<!-- 좋아요 수 증가 -->
	<update id="incrementLikeCount">
		UPDATE POST
		SET LIKE_COUNT = LIKE_COUNT + 1
		WHERE POST_ID = #{postId}
	</update>

	<!-- 좋아요 수 감소 -->
	<update id="decrementLikeCount">
		UPDATE POST
		SET LIKE_COUNT = LIKE_COUNT - 1
		WHERE POST_ID = #{postId}
		AND LIKE_COUNT > 0
	</update>

	<!-- 현재 좋아요 수 조회 -->
	<select id="selectLikeCount" resultType="int">
		SELECT LIKE_COUNT
		FROM POST
		WHERE POST_ID = #{postId}
	</select>
	<!-- 북마크 여부 확인 -->
	<select id="selectBookmarkExists" resultType="int">
		SELECT COUNT(*)
		FROM POST_BOOKMARK
		WHERE POST_ID = #{postId}
		AND MEMBER_ID = #{memberId}
	</select>

	<!-- 북마크 추가 -->
	<insert id="insertBookmark">
		INSERT INTO POST_BOOKMARK (BOOKMARK_ID, POST_ID, MEMBER_ID, CREATED_AT)
		VALUES (POST_BOOKMARK_SEQ.NEXTVAL, #{postId}, #{memberId}, SYSDATE)
	</insert>

	<!-- 북마크 취소 -->
	<delete id="deleteBookmark">
		DELETE FROM POST_BOOKMARK
		WHERE POST_ID = #{postId}
		AND MEMBER_ID = #{memberId}
	</delete>
	<!-- 이전 게시글 조회 -->
	<select id="selectPrevPost"
		resultType="kr.co.community.backend.post.dto.PostDTO">
		SELECT *
		FROM (
		SELECT
		POST_ID AS postId,
		TITLE AS title
		FROM POST
		WHERE POST_ID <![CDATA[<]]>
		#{currentPostId}
		AND CATEGORY_ID = #{categoryId}
		AND IS_DELETED = 'N'
		ORDER BY POST_ID DESC
		)
		WHERE ROWNUM = 1
	</select>

	<!-- 다음 게시글 조회 -->
	<select id="selectNextPost"
		resultType="kr.co.community.backend.post.dto.PostDTO">
		SELECT *
		FROM (
		SELECT
		POST_ID AS postId,
		TITLE AS title
		FROM POST
		WHERE POST_ID > #{currentPostId}
		AND CATEGORY_ID = #{categoryId}
		AND IS_DELETED = 'N'
		ORDER BY POST_ID ASC
		)
		WHERE ROWNUM = 1
	</select>

	<!-- 인기 게시글 조회 (조회수 기준 TOP N) -->
	<select id="selectViewTopPosts"
		resultType="kr.co.community.backend.post.dto.PostDTO">
		SELECT * FROM (
		SELECT
		P.POST_ID AS postId,
		P.TITLE AS title,
		NVL(M.NICKNAME, M.NAME) AS authorName,
		C.CATEGORY_NAME AS category,
		P.VIEW_COUNT AS viewCount,
		P.LIKE_COUNT AS likeCount,
		P.COMMENT_COUNT AS commentCount,
		P.CREATED_AT AS createdAt
		FROM POST P
		JOIN MEMBER M ON P.AUTHOR_ID = M.MEMBER_ID
		JOIN BOARD_CATEGORY C ON P.CATEGORY_ID = C.CATEGORY_ID
		WHERE P.IS_DELETED = 'N'
		ORDER BY P.VIEW_COUNT DESC, P.LIKE_COUNT DESC, P.POST_ID DESC
		)
		WHERE ROWNUM <![CDATA[<=]]>
		#{limit}
	</select>

	<!-- 작성자의 다른 글 조회 (현재 글 제외, 최신순) -->
	<select id="selectAuthorOtherPosts"
		resultType="kr.co.community.backend.post.dto.PostDTO">
		SELECT * FROM (
		SELECT
		P.POST_ID AS postId,
		P.TITLE AS title,
		P.VIEW_COUNT AS viewCount,
		P.LIKE_COUNT AS likeCount,
		P.COMMENT_COUNT AS commentCount,
		P.CREATED_AT AS createdAt
		FROM POST P
		WHERE P.AUTHOR_ID = #{authorId}
		AND P.POST_ID != #{currentPostId}
		AND P.IS_DELETED = 'N'
		ORDER BY P.CREATED_AT DESC, P.POST_ID DESC
		)
		WHERE ROWNUM <![CDATA[<=]]>
		#{limit}
	</select>

	<!-- 작성자의 게시글 수 조회 -->
	<select id="countAuthorPosts" resultType="int">
		SELECT COUNT(*)
		FROM POST
		WHERE AUTHOR_ID = #{authorId}
		AND IS_DELETED = 'N'
	</select>

	<!-- 작성자의 댓글 수 조회 -->
	<select id="countAuthorComments" resultType="int">
		SELECT COUNT(*)
		FROM COMMENTS
		WHERE AUTHOR_ID = #{authorId}
		AND IS_DELETED = 'N'
	</select>

	<!-- 게시글 삭제 (소프트 삭제) -->
	<update id="updateIsDeleted">
		UPDATE POST
		SET IS_DELETED = 'Y',
		UPDATED_AT = SYSDATE
		WHERE POST_ID = #{postId}
	</update>
	
	<!-- ✅ 댓글 작성 -->
  <insert id="insertComment" parameterType="kr.co.community.backend.post.dto.CommentDTO">
    <selectKey keyProperty="commentId" resultType="long" order="BEFORE">
      SELECT COMMENT_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO COMMENTS (
      COMMENT_ID,
      POST_ID,
      AUTHOR_ID,
      PARENT_COMMENT_ID,
      CONTENT,
      IS_DELETED,
      CREATED_AT
    ) VALUES (
      #{commentId},
      #{postId},
      #{authorId},
      #{parentCommentId},
      #{content},
      'N',
      SYSDATE
    )
  </insert>

  <!-- ✅ 게시글의 댓글 수 증가 -->
  <update id="incrementCommentCount">
    UPDATE POST
    SET COMMENT_COUNT = COMMENT_COUNT + 1
    WHERE POST_ID = #{postId}
  </update>
	
</mapper>
