<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.community.backend.post.dao.PostSsrDao">

  <!-- 카테고리 탭 -->
  <select id="selectActiveCategories" resultType="kr.co.community.backend.category.dto.BoardCategoryDTO">
    SELECT
      CATEGORY_ID   AS categoryId,
      CATEGORY_NAME AS categoryName,
      SORT_ORDER    AS sortOrder,
      IS_ACTIVE     AS isActive
    FROM BOARD_CATEGORY
    WHERE IS_ACTIVE = 'Y'
    ORDER BY SORT_ORDER ASC, CATEGORY_ID ASC
  </select>

  <!-- total -->
  <select id="countPostList" resultType="int">
    SELECT COUNT(*)
    FROM POST P
    JOIN BOARD_CATEGORY C ON C.CATEGORY_ID = P.CATEGORY_ID
    JOIN MEMBER M ON M.MEMBER_ID = P.AUTHOR_ID
    WHERE P.IS_DELETED = 'N'
      AND C.IS_ACTIVE = 'Y'
      <if test="categoryId != null">
        AND P.CATEGORY_ID = #{categoryId}
      </if>
      <if test="q != null and q != ''">
        AND (
          P.TITLE LIKE '%' || #{q} || '%'
          OR DBMS_LOB.SUBSTR(P.CONTENT, 2000, 1) LIKE '%' || #{q} || '%'
          OR NVL(M.NICKNAME, M.NAME) LIKE '%' || #{q} || '%'
        )
      </if>
  </select>

  <!-- list -->
<select id="selectPostList" resultType="kr.co.community.backend.post.dto.PostListDTO">
  SELECT *
  FROM (
    SELECT
      T.*,
      ROW_NUMBER() OVER (
        ORDER BY T.createdAt DESC, T.postId DESC
      ) AS RN
    FROM (
      SELECT
        P.POST_ID       AS postId,
        P.CATEGORY_ID   AS categoryId,
        C.CATEGORY_NAME AS categoryName,
        P.AUTHOR_ID     AS authorId,
        NVL(M.NICKNAME, M.NAME) AS authorName,
        P.TITLE         AS title,
        DBMS_LOB.SUBSTR(P.CONTENT, 120, 1) AS contentPreview,
        P.VIEW_COUNT    AS viewCount,
        P.LIKE_COUNT    AS likeCount,
        P.COMMENT_COUNT AS commentCount,
        P.CREATED_AT    AS createdAt
      FROM POST P
      JOIN BOARD_CATEGORY C ON C.CATEGORY_ID = P.CATEGORY_ID
      JOIN MEMBER M ON M.MEMBER_ID = P.AUTHOR_ID
      WHERE P.IS_DELETED = 'N'
        AND C.IS_ACTIVE = 'Y'
        <if test="categoryId != null">
          AND P.CATEGORY_ID = #{categoryId}
        </if>
        <if test="q != null and q != ''">
          AND (
            P.TITLE LIKE '%' || #{q} || '%'
            OR DBMS_LOB.SUBSTR(P.CONTENT, 2000, 1) LIKE '%' || #{q} || '%'
            OR NVL(M.NICKNAME, M.NAME) LIKE '%' || #{q} || '%'
          )
        </if>
    ) T
  )
  WHERE RN BETWEEN #{startRow} AND #{endRow}
  ORDER BY RN
</select>

 <!-- 게시글 단건 조회 -->
  <select id="selectPostById" parameterType="long" resultType="kr.co.community.backend.post.dto.PostDTO">
    SELECT
      P.POST_ID       AS postId,
      P.CATEGORY_ID   AS categoryId,
      P.AUTHOR_ID     AS authorId,
      P.TITLE         AS title,
      P.CONTENT       AS content,
      P.VIEW_COUNT    AS viewCount,
      P.LIKE_COUNT    AS likeCount,
      P.COMMENT_COUNT AS commentCount,
      P.IS_DELETED    AS isDeleted,
      P.CREATED_AT    AS createdAt,
      P.UPDATED_AT    AS updatedAt,
      C.CATEGORY_NAME AS category,
      NVL(M.NICKNAME, M.NAME) AS authorName
    FROM POST P
    LEFT JOIN BOARD_CATEGORY C ON P.CATEGORY_ID = C.CATEGORY_ID
    LEFT JOIN MEMBER M ON P.AUTHOR_ID = M.MEMBER_ID
    WHERE P.POST_ID = #{postId}
      AND P.IS_DELETED = 'N'
  </select>

  <!-- 조회수 증가 -->
  <update id="updateViewCount" parameterType="long">
    UPDATE POST
    SET VIEW_COUNT = VIEW_COUNT + 1
    WHERE POST_ID = #{postId}
  </update>

  <!-- 댓글 목록 조회 -->
  <select id="selectCommentsByPostId" parameterType="long" resultType="kr.co.community.backend.post.dto.CommentDTO">
    SELECT
      C.COMMENT_ID        AS commentId,
      C.POST_ID           AS postId,
      C.AUTHOR_ID         AS authorId,
      C.PARENT_COMMENT_ID AS parentCommentId,
      C.CONTENT           AS content,
      C.IS_DELETED        AS isDeleted,
      C.CREATED_AT        AS createdAt,
      C.UPDATED_AT        AS updatedAt,
      NVL(M.NICKNAME, M.NAME) AS authorName
    FROM COMMENTS C
    LEFT JOIN MEMBER M ON C.AUTHOR_ID = M.MEMBER_ID
    WHERE C.POST_ID = #{postId}
      AND C.IS_DELETED = 'N'
      AND C.PARENT_COMMENT_ID IS NULL
    ORDER BY C.CREATED_AT ASC
  </select>

  <!-- 좋아요 여부 확인 -->
  <select id="selectPostLikeExists" resultType="int">
    SELECT COUNT(*)
    FROM POST_LIKE
    WHERE POST_ID = #{postId}
      AND MEMBER_ID = #{memberId}
  </select>

  <!-- 좋아요 추가 -->
  <insert id="insertPostLike">
    INSERT INTO POST_LIKE (POST_ID, MEMBER_ID, CREATED_AT)
    VALUES (#{postId}, #{memberId}, SYSDATE)
  </insert>

  <!-- 좋아요 취소 -->
  <delete id="deletePostLike">
    DELETE FROM POST_LIKE
    WHERE POST_ID = #{postId}
      AND MEMBER_ID = #{memberId}
  </delete>

  <!-- 좋아요 수 증가 -->
  <update id="incrementLikeCount">
    UPDATE POST
    SET LIKE_COUNT = LIKE_COUNT + 1
    WHERE POST_ID = #{postId}
  </update>

  <!-- 좋아요 수 감소 -->
  <update id="decrementLikeCount">
    UPDATE POST
    SET LIKE_COUNT = LIKE_COUNT - 1
    WHERE POST_ID = #{postId}
      AND LIKE_COUNT > 0
  </update>

  <!-- 현재 좋아요 수 조회 -->
  <select id="selectLikeCount" resultType="int">
    SELECT LIKE_COUNT
    FROM POST
    WHERE POST_ID = #{postId}
  </select>

</mapper>
