<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="/communityCss/header.css">
<!-- ⭐ 추가 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <header th:fragment="header" class="header">
        <div class="header-container">
            <a href="/mainpage" class="logo">
                <span class="logo-icon">◀</span>
                <span class="logo-text">커뮤니티</span>
            </a>
            
            <nav class="header-nav">
                <a href="/mainpage" class="nav-link">홈</a>
                <a href="/board" class="nav-link">게시판</a>
                <a href="/notice" class="nav-link">공지사항</a>
                <a href="/minigame/apple" class="nav-link">미니게임</a>
            </nav>

            <div class="header-right">
                <!-- ✅ 비로그인 상태: 로그인/회원가입 버튼 -->
                <th:block th:unless="${isAuthenticated}">
                    <button class="btn-login" onclick="location.href='/app/login'">로그인</button>
                    <button class="btn-signup" onclick="location.href='/app/signup'">회원가입</button>
                </th:block>

                <!-- ✅ 로그인 상태: 알림 + 프로필 드롭다운 -->
                <th:block th:if="${isAuthenticated}">
                    <!-- 알림 아이콘 -->
                    <a href="/app/alert" class="notification-link">
                        <svg class="notification-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-badge" th:if="${unreadCount != null and unreadCount > 0}"></span>
                    </a>

                    <!-- 프로필 드롭다운 -->
                    <div class="profile-dropdown">
                        <button class="profile-button" onclick="toggleDropdown()">
                            <!-- 프로필 이미지 (선택사항) -->
                            <!-- <img th:src="${profileImage}" alt="프로필" class="profile-image" onerror="this.src='/images/default-profile.png'"> -->
                            <span class="profile-name" th:text="${nickname}">사용자</span>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>

                        <div class="dropdown-menu" id="dropdownMenu">
                            <a href="/app/profile" class="dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                <span>내 프로필</span>
                            </a>
                            <a href="/app/settings" class="dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6"></path>
                                </svg>
                                <span>설정</span>
                            </a>
                            <a href="/my-posts" class="dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                <span>내 게시글</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="/mainpage" class="dropdown-item logout" onclick="logout(); return false;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                <span>로그아웃</span>
                            </a>
                        </div>
                    </div>
                </th:block>
            </div>
        </div>
    </header>

    <script>
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('active');
        }

        // 외부 클릭시 드롭다운 닫기
        document.addEventListener('click', function(e) {
            const profileDropdown = document.querySelector('.profile-dropdown');
            const dropdown = document.getElementById('dropdownMenu');

            if (profileDropdown && dropdown && !profileDropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // 로그아웃
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                fetch('/api/member/logout', {
                    method: 'POST',
                    credentials: 'include',
                   	headers: { 
                        'Content-Type': 'application/json'
                    }
                })
                .then(res => {
                    console.log('응답 상태:', res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('응답 데이터:', data);
                    if (data && data.success) {
                        alert('로그아웃 되었습니다.');
                        window.location.href = '/mainpage';
                    } else {
                        alert('로그아웃에 실패했습니다.');
                    }
                })
                .catch(err => {
                    console.error('로그아웃 오류:', err);
                    alert('로그아웃 중 오류가 발생했습니다.');
                });
            }
        }

        /**
         * ⭐ [중복 로그인] SSR 페이지 로드 시 로그인 상태 체크
         * 
         * SSR 페이지에서만 작동 (CSR 페이지는 React Header가 담당)
         * 
         * 동작 방식:
         * 1. 페이지 로드 시 /api/member/me 호출
         * 2. 401 에러 나면 = DB에 토큰 없음 (다른 기기에서 로그인함)
         * 3. localStorage에 로그인 정보 있으면 알림 표시
         * 4. sessionStorage에 플래그 저장 (알림 중복 방지)
         * 
         * 제외 페이지:
         * - /app/login, /app/signup: 이미 로그아웃된 상태라 체크 불필요
         * - /app/settings, /app/profile, /app/alert: CSR 페이지라 React Header가 담당
         */
        async function checkLoginStatus() {
            // ⭐ 제외 페이지 체크
            // - 로그인/회원가입: 이미 알림 떴고 로그아웃된 상태
            // - 설정/프로필/알림: CSR 페이지라 React Header에서 체크함
            const currentPath = window.location.pathname;
            if (currentPath === '/app/login' || 
                currentPath === '/app/signup' ||
                currentPath === '/app/settings' ||
                currentPath === '/app/profile' ||
                currentPath === '/app/alert') {
                return;  // 체크 안 함
            }
            
            try {
                // ⭐ 로그인 상태 확인 API 호출
                const response = await fetch('/api/member/me', {
                    credentials: 'include'  // 쿠키 전송
                });
                
                // ⭐ 401 에러 = DB에 토큰 없음 (다른 기기에서 로그인함)
                if (response.status === 401) {
                    // localStorage에 로그인 정보 확인
                    const hasLoginUser = localStorage.getItem('loginUser');
                    
                    // ⭐ [알림 중복 방지]
                    // sessionStorage = 브라우저 탭 닫으면 자동 삭제
                    const alreadyShown = sessionStorage.getItem('logoutAlertShown');
                    
                    // ⭐ 알림 표시 조건
                    // - 로그인 정보가 있었음 (로그인 상태였음)
                    // - 아직 알림 안 띄웠음
                    if (hasLoginUser && !alreadyShown) {
                        // 즉시 삭제 (알림 표시 전에 삭제)
                        localStorage.removeItem('loginUser');
                        
                        // ⭐ 알림 표시했다고 표시 (세션 동안 유지)
                        sessionStorage.setItem('logoutAlertShown', 'true');
                        
                        // ⭐ 스윗얼럿으로 알림 표시
                        Swal.fire({
                            icon: 'warning',
                            title: '로그아웃되었습니다',
                            text: '다른 기기에서 로그인하여 자동 로그아웃되었습니다.',
                            confirmButtonText: '확인',
                            allowOutsideClick: false  // 외부 클릭 막기
                        }).then(() => {
                            // 페이지 새로고침 (로그아웃 상태로 갱신)
                            window.location.reload();
                        });
                    }
                }
            } catch (e) {
                console.log('로그인 상태 체크 에러:', e);
            }
        }

        // ⭐ 페이지 로드 시 실행
        // DOMContentLoaded = HTML 로드 완료 후 실행
        document.addEventListener('DOMContentLoaded', checkLoginStatus);
    </script>
</body>
</html>